!function(B,R,g){"use strict";var q="ht",s=B[q],P=s.Default,S=P.def,k=P.getInternal();s.HistoryManager=function(Y){this._histories=[],this.setDataModel(Y)},S(s.HistoryManager,R,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var J=this;J._betweenTransaction++,1===J._betweenTransaction&&(J._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var U=this,x=U._histories;if(U._betweenTransaction>0&&U._betweenTransaction--,0===U._betweenTransaction){if(U._transactionHistories){var M=[];for(var Y in U._transactionHistories)M.push(U._transactionHistories[Y]);M.length&&(x=x.slice(0,U._historyIndex+1),x.push(M),x.length>U._maxHistoryCount&&(x=x.slice(x.length-U._maxHistoryCount)),U.setHistories(x),U.setHistoryIndex(x.length-1,!0))}delete U._transactionHistories}}},setDataModel:function(V){var Y=this,d=Y._dataModel;d!==V&&(d&&(delete d._historyManager,d.ump(Y.handleDataModelPropertyChange,Y),d.umm(Y.$5p,Y),d.umd(Y.$6p,Y),d.removeHierarchyChangeListener(Y.handleHierarchyChange,Y),d.removeIndexChangeListener(Y.handleIndexChange,Y)),Y._dataModel=V,V&&(V._historyManager=Y,V.mp(Y.handleDataModelPropertyChange,Y),V.mm(Y.$5p,Y),V.md(Y.$6p,Y),V.addHierarchyChangeListener(Y.handleHierarchyChange,Y),V.addIndexChangeListener(Y.handleIndexChange,Y)),Y.fp("dataModel",d,V),Y.clear())},setHistoryIndex:function(H,W){var b=this,I=b._historyIndex,U=b._histories.length;if(-1>H?H=-1:H>=U&&(H=U-1),I!==H){if(!W){var m=H-I;m>0?b.$2p(m):0>m&&b.$1p(-m)}b._historyIndex=H,b.fp("historyIndex",I,H),b.dataModel&&b.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(w){var p=this,U=p._histories,n=p._maxHistoryCount;(!w||0>=w)&&(w=10),n!==w&&(p._maxHistoryCount=w,p.fp("maxHistoryCount",n,w),U.length>w&&p.clear())},cloneValue:function(j){return s.Default.clone(j)},isPropertyUndoable:function(s){return s&&!this.ignoredPropertyMap[s]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(r){return r&&!this.ignoreDataModelPropertyMap[r]},$5p:function(W){this.handleChange(W,W.kind)},$6p:function(t){this.handleChange(t,"property")},handleHierarchyChange:function(t){this.handleChange(t,"hierarchy")},handleIndexChange:function(y){this.handleChange(y,"index")},handleDataModelPropertyChange:function(z){this.handleChange(z,"dataModelProperty")},toChildrenInfo:function(t){var A={};return A.data=t,A.children=[],t.eachChild(function(t){A.children.push(this.toChildrenInfo(t))},this),A},restoreChildren:function(u){var i=u.data;u.children.forEach(function(A){var I=A.data;I.getParent()!==i&&i.addChild(I),this._dataModel.contains(I)||this._dataModel.add(I),this.restoreChildren(A)},this)},handleChange:function(k,o){var N=this;if(!(N._disabled||N._isUndoRedoing||P.loadingRefGraph)){var U,W=(N._histories,k.data),J=k.property;if(!W||!(W._refGraph||W instanceof s.RefGraph)){if("property"===o)N.isPropertyUndoable(J,W)&&(U={kind:o,data:W,property:J,oldValue:N.cloneValue(k.oldValue,W,J),newValue:N.cloneValue(k.newValue,W,J),event:k});else if("hierarchy"===o||"index"===o&&N.isIndexUndoable(k))U={kind:o,data:W,oldIndex:k.oldIndex,newIndex:k.newIndex,event:k};else if("clear"===o)U={kind:o,json:k.json,event:k};else if("add"===o){if(U={kind:o,data:W,event:k,childrenInfo:this.toChildrenInfo(W),parent:W.getParent()},U.parent){var M=N._dataModel.getSiblings(W);U.siblingsIndex=M.indexOf(W)}W instanceof s.Node&&(U.host=W.getHost(),U.attaches=W.getAttaches()?W.getAttaches().toArray():g),W instanceof s.Edge&&(U.source=W.getSource(),U.target=W.getTarget())}else"remove"===o?U={kind:o,data:W,event:k}:"dataModelProperty"===o&&N.isDataModelPropertyUndoable(J,W)&&(U={kind:o,property:J,oldValue:N.cloneValue(k.oldValue,W,J),newValue:N.cloneValue(k.newValue,W,J),event:k});N.addHistory(U)}}},addHistory:function(O){var P=this;if(O)if(P._betweenTransaction){var X=(O.data?O.data._id:0)+"_"+O.kind+"_"+O.property;if("property"===O.kind||"dataModelProperty"===O.kind){var $=P._transactionHistories[X];$&&(O.oldValue=$.oldValue)}P._transactionHistories[X]=O}else{var u=P._histories;u=u.slice(0,P._historyIndex+1),u.push([O]),u.length>P._maxHistoryCount&&(u=u.slice(u.length-P._maxHistoryCount)),P.setHistories(u),P.setHistoryIndex(u.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(w){(!w||0>=w)&&(w=1),this.setHistoryIndex(this._historyIndex-w)},$1p:function(r){if(this.canUndo()){var W,l=this,F=l._dataModel,J=l._histories,f=l._historyIndex,D=0;for(l._isUndoRedoing=!0,P.setIsolating(!0);r>0;){if(f>=0&&f<J.length){D++,W=J[f],f--;for(var w=W.length-1;w>=0;w--){var y=W[w],B=y.kind,j=y.data,e=y.property,G=y.event,M=this.cloneValue(y.oldValue,j,e);if(y.undo)y.undo();else if("add"===B)F.remove(j,{keepChildren:!0});else if("remove"===B)F.contains(j)||F.add(j,G.rootsIndex,G.datasIndex);else if("clear"===B)F.deserialize(P.clone(y.json));else if("property"===B)if("parent"===e)M?M.addChild(j,G.oldIndex):(j.setParent(M),G.oldIndex>=0&&F.moveTo(j,G.oldIndex));else{var A=null;0===e.indexOf("a:")?(A="attr",e=e.replace("a:","")):0===e.indexOf("s:")?(A="style",e=e.replace("s:","")):0===e.indexOf("f:")&&(A="field",e=e.replace("f:","")),k.setPropertyValue(j,A,e,M)}else if("dataModelProperty"===B){var A=null;0===e.indexOf("a:")?(A="attr",e=e.replace("a:","")):0===e.indexOf("s:")?(A="style",e=e.replace("s:","")):0===e.indexOf("f:")&&(A="field",e=e.replace("f:","")),k.setPropertyValue(F,A,e,M)}else"hierarchy"===B?F.moveTo(j,y.oldIndex):"index"===B&&F.moveToIndex(j,y.oldIndex)}}r--}P.setIsolating(!1),delete l._isUndoRedoing,l.afterUndo(D)}},afterUndo:function(){},redo:function(N){(!N||0>=N)&&(N=1),this.setHistoryIndex(this._historyIndex+N)},$2p:function(A){if(this.canRedo()){var B,J=this,F=J._dataModel,U=J._histories,K=J._historyIndex,c=0;for(J._isUndoRedoing=!0,P.setIsolating(!0);A>0;){if(K>=-1&&K<U.length-1){c++,K++,B=U[K];for(var x=0;x<B.length;x++){var W=B[x],n=W.kind,e=W.data,V=W.property,m=W.event,E=this.cloneValue(W.newValue,e,V);if(W.redo)W.redo();else if("add"===n)W.parent&&!e.getParent()&&W.parent.addChild(e,W.siblingsIndex),F.contains(e)||F.add(e,m.rootsIndex,m.datasIndex),this.restoreChildren(W.childrenInfo),e instanceof s.Node&&(e.setHost(W.host),W.attaches&&W.attaches.forEach(function(G){G.setHost(e)})),e instanceof s.Edge&&(e.setSource(W.source),e.setTarget(W.target));else if("remove"===n)F.remove(e);else if("clear"===n)F.clear();else if("property"===n)if("parent"===V)E?E.addChild(e,m.newIndex):(e.setParent(E),m.newIndex>=0&&F.moveTo(e,m.newIndex));else{var z=null;0===V.indexOf("a:")?(z="attr",V=V.replace("a:","")):0===V.indexOf("s:")?(z="style",V=V.replace("s:","")):0===V.indexOf("f:")&&(z="field",V=V.replace("f:","")),k.setPropertyValue(e,z,V,E)}else if("dataModelProperty"===n){var z=null;0===V.indexOf("a:")?(z="attr",V=V.replace("a:","")):0===V.indexOf("s:")?(z="style",V=V.replace("s:","")):0===V.indexOf("f:")&&(z="field",V=V.replace("f:","")),k.setPropertyValue(F,z,V,E)}else"hierarchy"===n?F.moveTo(e,W.newIndex):"index"===n&&F.moveToIndex(e,W.newIndex)}}A--}P.setIsolating(!1),delete J._isUndoRedoing,this.afterRedo(c)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);