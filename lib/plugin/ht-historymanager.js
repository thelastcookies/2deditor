!function(v,X,x){"use strict";var R="ht",E=v[R],r=E.Default,z=r.def,C=r.getInternal();E.HistoryManager=function(S){this._histories=[],this.setDataModel(S)},z(E.HistoryManager,X,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var m=this;m._betweenTransaction++,1===m._betweenTransaction&&(m._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var y=this,n=y._histories;if(y._betweenTransaction>0&&y._betweenTransaction--,0===y._betweenTransaction){if(y._transactionHistories){var v=[];for(var s in y._transactionHistories)v.push(y._transactionHistories[s]);v.length&&(n=n.slice(0,y._historyIndex+1),n.push(v),n.length>y._maxHistoryCount&&(n=n.slice(n.length-y._maxHistoryCount)),y.setHistories(n),y.setHistoryIndex(n.length-1,!0))}delete y._transactionHistories}}},setDataModel:function(b){var M=this,w=M._dataModel;w!==b&&(w&&(delete w._historyManager,w.ump(M.handleDataModelPropertyChange,M),w.umm(M.$5p,M),w.umd(M.$6p,M),w.removeHierarchyChangeListener(M.handleHierarchyChange,M),w.removeIndexChangeListener(M.handleIndexChange,M)),M._dataModel=b,b&&(b._historyManager=M,b.mp(M.handleDataModelPropertyChange,M),b.mm(M.$5p,M),b.md(M.$6p,M),b.addHierarchyChangeListener(M.handleHierarchyChange,M),b.addIndexChangeListener(M.handleIndexChange,M)),M.fp("dataModel",w,b),M.clear())},setHistoryIndex:function(S,u){var v=this,w=v._historyIndex,I=v._histories.length;if(-1>S?S=-1:S>=I&&(S=I-1),w!==S){if(!u){var i=S-w;i>0?v.$2p(i):0>i&&v.$1p(-i)}v._historyIndex=S,v.fp("historyIndex",w,S),v.dataModel&&v.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(f){var k=this,g=k._histories,p=k._maxHistoryCount;(!f||0>=f)&&(f=10),p!==f&&(k._maxHistoryCount=f,k.fp("maxHistoryCount",p,f),g.length>f&&k.clear())},cloneValue:function(n){return E.Default.clone(n)},isPropertyUndoable:function(X){return X&&!this.ignoredPropertyMap[X]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(V){return V&&!this.ignoreDataModelPropertyMap[V]},$5p:function(j){this.handleChange(j,j.kind)},$6p:function(X){this.handleChange(X,"property")},handleHierarchyChange:function(F){this.handleChange(F,"hierarchy")},handleIndexChange:function(T){this.handleChange(T,"index")},handleDataModelPropertyChange:function(w){this.handleChange(w,"dataModelProperty")},toChildrenInfo:function(y){var t={};return t.data=y,t.children=[],y.eachChild(function(s){t.children.push(this.toChildrenInfo(s))},this),t},restoreChildren:function(r){var R=r.data;r.children.forEach(function(A){var c=A.data;c.getParent()!==R&&R.addChild(c),this._dataModel.contains(c)||this._dataModel.add(c),this.restoreChildren(A)},this)},handleChange:function(X,t){var _=this;if(!(_._disabled||_._isUndoRedoing||r.loadingRefGraph)){var u,Q=(_._histories,X.data),d=X.property;if(!Q||!(Q._refGraph||Q instanceof E.RefGraph)){if("property"===t)_.isPropertyUndoable(d,Q)&&(u={kind:t,data:Q,property:d,oldValue:_.cloneValue(X.oldValue,Q,d),newValue:_.cloneValue(X.newValue,Q,d),event:X});else if("hierarchy"===t||"index"===t&&_.isIndexUndoable(X))u={kind:t,data:Q,oldIndex:X.oldIndex,newIndex:X.newIndex,event:X};else if("clear"===t)u={kind:t,json:X.json,event:X};else if("add"===t){if(u={kind:t,data:Q,event:X,childrenInfo:this.toChildrenInfo(Q),parent:Q.getParent()},u.parent){var e=_._dataModel.getSiblings(Q);u.siblingsIndex=e.indexOf(Q)}Q instanceof E.Node&&(u.host=Q.getHost(),u.attaches=Q.getAttaches()?Q.getAttaches().toArray():x),Q instanceof E.Edge&&(u.source=Q.getSource(),u.target=Q.getTarget())}else"remove"===t?u={kind:t,data:Q,event:X}:"dataModelProperty"===t&&_.isDataModelPropertyUndoable(d,Q)&&(u={kind:t,property:d,oldValue:_.cloneValue(X.oldValue,Q,d),newValue:_.cloneValue(X.newValue,Q,d),event:X});_.addHistory(u)}}},addHistory:function(k){var J=this;if(k)if(J._betweenTransaction){var G=(k.data?k.data._id:0)+"_"+k.kind+"_"+k.property;if("property"===k.kind||"dataModelProperty"===k.kind){var v=J._transactionHistories[G];v&&(k.oldValue=v.oldValue)}J._transactionHistories[G]=k}else{var n=J._histories;n=n.slice(0,J._historyIndex+1),n.push([k]),n.length>J._maxHistoryCount&&(n=n.slice(n.length-J._maxHistoryCount)),J.setHistories(n),J.setHistoryIndex(n.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(A){(!A||0>=A)&&(A=1),this.setHistoryIndex(this._historyIndex-A)},$1p:function(Z){if(this.canUndo()){var l,g=this,N=g._dataModel,q=g._histories,I=g._historyIndex,S=0;for(g._isUndoRedoing=!0,r.setIsolating(!0);Z>0;){if(I>=0&&I<q.length){S++,l=q[I],I--;for(var D=l.length-1;D>=0;D--){var h=l[D],w=h.kind,t=h.data,J=h.property,j=h.event,F=this.cloneValue(h.oldValue,t,J);if(h.undo)h.undo();else if("add"===w)N.remove(t,{keepChildren:!0});else if("remove"===w)N.contains(t)||N.add(t,j.rootsIndex,j.datasIndex);else if("clear"===w)N.deserialize(r.clone(h.json));else if("property"===w)if("parent"===J)F?F.addChild(t,j.oldIndex):(t.setParent(F),j.oldIndex>=0&&N.moveTo(t,j.oldIndex));else{var v=null;0===J.indexOf("a:")?(v="attr",J=J.replace("a:","")):0===J.indexOf("s:")?(v="style",J=J.replace("s:","")):0===J.indexOf("f:")&&(v="field",J=J.replace("f:","")),C.setPropertyValue(t,v,J,F)}else if("dataModelProperty"===w){var v=null;0===J.indexOf("a:")?(v="attr",J=J.replace("a:","")):0===J.indexOf("s:")?(v="style",J=J.replace("s:","")):0===J.indexOf("f:")&&(v="field",J=J.replace("f:","")),C.setPropertyValue(N,v,J,F)}else"hierarchy"===w?N.moveTo(t,h.oldIndex):"index"===w&&N.moveToIndex(t,h.oldIndex)}}Z--}r.setIsolating(!1),delete g._isUndoRedoing,g.afterUndo(S)}},afterUndo:function(){},redo:function(P){(!P||0>=P)&&(P=1),this.setHistoryIndex(this._historyIndex+P)},$2p:function(m){if(this.canRedo()){var X,u=this,R=u._dataModel,n=u._histories,q=u._historyIndex,o=0;for(u._isUndoRedoing=!0,r.setIsolating(!0);m>0;){if(q>=-1&&q<n.length-1){o++,q++,X=n[q];for(var j=0;j<X.length;j++){var K=X[j],B=K.kind,k=K.data,t=K.property,I=K.event,h=this.cloneValue(K.newValue,k,t);if(K.redo)K.redo();else if("add"===B)K.parent&&!k.getParent()&&K.parent.addChild(k,K.siblingsIndex),R.contains(k)||R.add(k,I.rootsIndex,I.datasIndex),this.restoreChildren(K.childrenInfo),k instanceof E.Node&&(k.setHost(K.host),K.attaches&&K.attaches.forEach(function(G){G.setHost(k)})),k instanceof E.Edge&&(k.setSource(K.source),k.setTarget(K.target));else if("remove"===B)R.remove(k);else if("clear"===B)R.clear();else if("property"===B)if("parent"===t)h?h.addChild(k,I.newIndex):(k.setParent(h),I.newIndex>=0&&R.moveTo(k,I.newIndex));else{var d=null;0===t.indexOf("a:")?(d="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(d="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(d="field",t=t.replace("f:","")),C.setPropertyValue(k,d,t,h)}else if("dataModelProperty"===B){var d=null;0===t.indexOf("a:")?(d="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(d="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(d="field",t=t.replace("f:","")),C.setPropertyValue(R,d,t,h)}else"hierarchy"===B?R.moveTo(k,K.newIndex):"index"===B&&R.moveToIndex(k,K.newIndex)}}m--}r.setIsolating(!1),delete u._isUndoRedoing,this.afterRedo(o)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);