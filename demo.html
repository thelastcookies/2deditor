<!DOCTYPE html>
<html>
<head>
    <title>Demo</title>
    <style>
        body {
            background-color: #000;
            opacity: 0.8;
        }
    </style>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="lib/core/ht.js"></script>
    <script type="text/javascript" src="js/ht-value.js"></script>
    <script src="bootstrap-3.3.7-dist/js/jquery-3.1.1.js"></script>
    <script src="lib/plugin/ht-contextmenu.js"></script>
    <script src="lib/plugin/ht-cssanimation.js"></script>
    <script src="lib/plugin/ht-form.js"></script>
    <script src="lib/plugin/ht-dialog.js"></script>
    <script src="lib/plugin/ht-palette.js"></script>
    <script src="lib/plugin/ht-rulerframe.js"></script>
    <script src="lib/plugin/ht-propertypane.js"></script>
    <script src="lib/plugin/ht-edgetype.js"></script>

    <script src="config/contextmenu-config.js"></script>
    <script src="config/dialog-config.js"></script>
    <script>
        function init() {
            dataModel = new ht.DataModel();
            graphView = window.graph = new ht.graph.GraphView(dataModel);
            graphView.getSelectionModel().setSelectionMode('single');

            // dataModel.deserialize(json);
            graphView.mi(function(e) {
                if (e.kind === 'clickData') {
                    if (e.data.getTag() === 'DJX') {
                        window.location.href = 'index.html';
                    }
                }
            });
            // 配置右键菜单
            setContextMenu(load_contextmenu_config, graphView);
            // 请求组态图数据以及初始化
            $.getJSON({
                url: './test.cfd',
                success: res => {
                    json = res;
                    dataModel.deserialize(json);
                    nodeArr = dataModel.getNodeTags();
                    graphView.setMovableFunc(function() {});
                    // graphView.setSelectableFunc(function() {});
                    graphView.setPannable(false);
                    graphView.handleScroll = function() {};
                    let container = document.getElementById('container');
                    // pageMainView.addToDOM(container);
                    graphView.addToDOM(container);
                    graphView.fitContent(true);
                    getRealTimeData(nodeArr);
                }
            });


        }
        /**
         * getRealTimeData 获取实时数据
         * @param nodeArr - 需要请求参数的测点数组
         * @param timestamp - 请求时间
         */
        function getRealTimeData(nodeArr, timestamp) {
            getDataIntervalID = setInterval(() => {
                $.ajax ({
                    type: 'POST',
                    url: "http://localhost/node-trend.php",
                    data: {nodeTagArr: nodeArr, timestamp: '2020-07-01 00:00:00'},
                    dataType: "json",
                    success: function (res) {
                        dataToUse = dataModel.formulaPreprocess(res);
                        dataModel.setNodeStatusByValue(dataToUse);
                    }
                });
            }, 3000);
        }
        /**
         * setContextMenu 设置右键点击事件
         * @param contextmenu_config - 右键点击配置
         * @param graphView - graphView
         */
        function setContextMenu (contextmenu_config, graphView) {
            let contextmenu = new ht.widget.ContextMenu(contextmenu_config);
            contextmenu.enableGlobalKey();
            contextmenu.setVisibleFunc(function(item) {
                let data = graphView.sm().ld();
                if (data instanceof ht.Node) {
                    return item.fordata === 1;
                }
                else {
                    return item.fordata === 2;
                }
            });
            contextmenu.addTo(graphView.getView());
        }
    </script>
</head>
<body onload="init();">
<div id="container"></div>
</body>
</html>
