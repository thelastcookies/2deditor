<!DOCTYPE html>
<html>
<head>
    <title>Demo</title>
    <link href="progress-bar/progress-bar.css" rel="stylesheet"/>

    <style>
    </style>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="js/identifier.js"></script>
    <script type="text/javascript" src="js/math.js"></script>
    <script type="text/javascript" src="lib/core/ht.js"></script>
    <script type="text/javascript" src="js/ht-value.js"></script>
    <script src="lib/jquery/jquery-3.5.1.js"></script>
    <script src="lib/plugin/ht-contextmenu.js"></script>
    <script src="lib/plugin/ht-cssanimation.js"></script>
    <script src="lib/plugin/ht-form.js"></script>
    <script src="lib/plugin/ht-dialog.js"></script>
    <script src="lib/plugin/ht-palette.js"></script>
    <script src="lib/plugin/ht-rulerframe.js"></script>
    <script src="lib/plugin/ht-propertypane.js"></script>
    <script src="lib/plugin/ht-edgetype.js"></script>

    <!--右键菜单栏的内容-->
    <script src="config/dialog-config.js"></script>
    <script src="config/contextmenu-config.js"></script>

    <!--图表-->
    <script src="echarts/echarts.common.min.js"></script>
    <!--计算-->
    <script src="js/calculate.js"></script>
    <!--进度条-->
    <script src="progress-bar/progress-bar.js"></script>
    <script src="config/project-config.js"></script>

    <script>
        let dataModel = new ht.DataModel(),
            graphView = window.graph = new ht.graph.GraphView(dataModel),
            // 用于当前展示使用的数据
            dataToUse = [],
            historyData = [],
            json = null,
            nodeArr = [],
            nodeSelected = null;
        let getDataIntervalID = null;
        let progressBar = new ProgressBar();
        // let startTime = '2020-07-01 00:00:00',
        //     endTime = '2020-07-01 00:11:00',
        let interval = project_config.interval;
        let pageMainView = new ht.widget.SplitView (graphView, progressBar.progressDiv, 'v', -100);
        pageMainView.setStatus("cr");
        pageMainView.setDividerSize(1);



        function init() {
            // 给显示区域绑定事件
            graphView.mi(function(e) {
                if (e.kind === 'clickData') {
                    if (e.data.getTag() === 'DJX') {
                        window.location.href = 'index.html';
                    }
                } else if (e.kind === 'doubleClickData') {
                    showNodeDetails (e.data.getTag(), dataToUse, {x: e.event.x, y: e.event.y}, e.data.a('node.type'));
                } else if (e.kind === 'clickBackground') {
                    let div = document.getElementById("data-display-div");
                    if (div)
                        div.style.display = 'none';
                }
            });
            // 配置右键菜单
            setContextMenu(load_contextmenu_config, graphView);
            // 请求组态图数据以及初始化
            $.getJSON({
                url: './test.cfd',
                success: res => {
                    json = res;
                    dataModel.deserialize(json);
                    nodeArr = dataModel.getNodeTags();
                    graphView.setMovableFunc(function() {});
                    // graphView.setSelectableFunc(function() {});
                    graphView.setPannable(false);
                    graphView.handleScroll = function() {};
                    let container = document.getElementById('container');
                    pageMainView.addToDOM(container);
                    // graphView.addToDOM(container);
                    graphView.fitContent(true);
                    getRealTimeData(nodeArr);
                }
            });
        }
        /**
         * getRealTimeData 获取实时数据
         * @param nodeArr - 需要请求参数的测点数组
         * @param timestamp - 请求时间
         */
        function getRealTimeData(nodeArr, timestamp) {
            getDataIntervalID = setInterval(() => {
                $.ajax ({
                    type: 'POST',
                    url: "http://localhost/node-trend.php",
                    data: {nodeTagArr: nodeArr, timestamp: '2020-07-01 00:00:00'},
                    dataType: "json",
                    success: function (res) {
                        dataToUse = dataModel.formulaPreprocess(res);
                        dataModel.setNodeStatusByValue(dataToUse);
                    }
                });
            }, 3000);
        }

        /**
         * getHistoryData 获取历史数据
         * @param nodeArr - 需要请求参数的测点数组
         * @param startTime - 开始时间
         * @param endTime - 结束时间
         * @param interval - 数据间隔
         */
        // function getHistoryData(nodeArr, startTime, endTime, interval) {
        //     $.ajax ({
        //         type: 'POST',
        //         url: "http://localhost/node-trend.php",
        //         data: {
        //             "nodeTagArr": nodeArr,
        //             "startTime": startTime,
        //             "endTime": endTime,
        //             "interval": interval
        //         },
        //         dataType: "json",
        //         success: function (nodeData) {
        //             let dateResult = dataPretreat(nodeData, startTime, endTime, interval);
        //
        //             historyData = dateResult.data;
        //             progressBar.init(dateResult.timestampArr, progressCallback);
        //
        //             if (getDataIntervalID)
        //                 clearInterval(getDataIntervalID);
        //
        //             if (pageMainView) {
        //                 pageMainView.setStatus("normal");
        //                 graphView.fitContent(true);
        //             }
        //             else {
        //                 graphView.fitContent(true);
        //             }
        //         }
        //     });
        // }

        function getHistoryData(nodeArr, startTime, endTime, interval) {
            let timestampArr = [], data = [];
            let min = 0, hour = 0, timestamp = '', temp = [];
            for (let i = 0, len = 1200; i < len; i++) {
                if (i !== 0 && i % 60 === 0) {
                    min = 0;
                    hour ++;
                }
                timestamp = `2020-07-01 ${hour}:${min}:00`;
                timestampArr.push(timestamp);
                temp = [
                    {nodeTag: "HS:fd_zt_01", value: i, timestamp: timestamp, nodeDesc: "柱形图"}
                ];
                data.push(temp);
                min++;

            }
            console.log(timestampArr);
            historyData = data;
            progressBar.init(timestampArr, progressCallback);

            if (getDataIntervalID)
                clearInterval(getDataIntervalID);

            if (pageMainView) {
                pageMainView.setStatus("normal");
                graphView.fitContent(true);
            }
            else {
                graphView.fitContent(true);
            }
        }

        /**
         * setContextMenu 设置右键点击事件
         * @param contextmenu_config - 右键点击配置
         * @param graphView - graphView
         */
        function setContextMenu (contextmenu_config, graphView) {
            let contextmenu = new ht.widget.ContextMenu(contextmenu_config);
            contextmenu.enableGlobalKey();
            contextmenu.setVisibleFunc(function(item) {
                let data = graphView.sm().ld();
                if (data instanceof ht.Node) {
                    return item.fordata === 1;
                }
                else {
                    return item.fordata === 2;
                }
            });
            contextmenu.addTo(graphView.getView());
        }

        /**
         * showNodeDetails 用于双击测点时显示测点的详细信息
         * @param tag - 测点tag
         * @param data - 用于显示的测点信息
         * @param position - 点击事件的位置，用以确认弹出框的位置
         */
        function showNodeDetails (tag, data, position, type) {
            let htmlStr = "";
            if (data)
                for (let i = 0, len = data.length; i < len; i++) {
                    if (data[i].nodeTag === tag) {
                        nodeSelected = tag;
                        let value = '', height = 120;
                        if (type === 'zb1') {
                            value = `<br/>油温1：${data[i].value.yw1}<br/>油温2：${data[i].value.yw2}<br/>绕温：${data[i].value.rw}<br/>档位：${data[i].value.dw}`;
                        } else if (type === 'zb2') {
                            value = `<br/>主变油温1：${data[i].value.zbyw1}<br/>主变油温2：${data[i].value.zbyw2}<br/>绕组油温：${data[i].value.rzyw}<br/>档位：${data[i].value.dw}`;
                        } else {
                            value = data[i].value;
                            height = 30;
                        }
                        htmlStr += `
                                            <div id = "data-display-div" style="position: absolute;top: ${position.y + 10 + "px"};left: ${position.x + 10 + "px"};height: ${184 + height}px;box-sizing: border-box;opacity: 0.8;line-height: 30px;width: 280px;background-color: #fff; border: 1px solid #111;padding: 2px 5px;color: #444;border-radius: 5px;">
                                                <div style="height: 30px; ">标签名：${tag}</div>
                                                <div style="height: 30px; ">中文描述：${data[i].nodeDesc}</div>
                                                <div style="height: ${height}; ">值：<span id="node-value-by-time">${value}</span></div>
                                                <div style="height: 30px; ">时标：<span id="node-timestamp-by-time">${data[i].timestamp}</span></div>
                                                <div style="height: 30px; ">质量：</div>
                                                <div style="height: 30px; ">单位：</div>
                                                <div style="height: 30px; ">数据库：</div>
                                             </div>
                                        `;
                        let div = document.getElementById("data-display-div");
                        if (div) {
                            div.outerHTML = htmlStr;
                        } else {
                            div = document.createElement('div');
                            div.innerHTML = htmlStr;
                            document.getElementsByTagName('body')[0].appendChild(div);
                        }
                        return;
                    }
                }
        }

        /**
         * updateNodeDetails 用于在查看测点详细信息时测点数据改变的更新方法
         * @param value - 测点value
         * @param timestamp - 测点时间戳
         */
        function updateNodeDetails (value, timestamp, type) {
            let valueTemp = '';
            if (type === 'zb1') {
                valueTemp = `<br/>油温1：${value.yw1}<br/>油温2：${value.yw2}<br/>绕温：${value.rw}<br/>档位：${value.dw}`;
            } else if (type === 'zb2') {
                valueTemp = `<br/>主变油温1：${value.zbyw1}<br/>主变油温2：${value.zbyw2}<br/>绕组油温：${value.rzyw}<br/>档位：${value.dw}`;
            } else {
                valueTemp = value;
            }
            let nodeValueSpan = document.getElementById('node-value-by-time')
            let nodeTimeSpan = document.getElementById('node-timestamp-by-time')
            nodeValueSpan.innerHTML = valueTemp
            nodeTimeSpan.innerText = timestamp
        }

        /**
         * dataPretreat 用于处理从接口返回的数据
         * @param data - 返回数据
         * @param stTime - 开始时间
         * @param edTime - 结束时间
         * @param interval - 数据间隔
         */
        function dataPretreat (data, stTime, edTime, interval) {
            let timeStepCount = Math.floor((Date.parse(edTime) - Date.parse(stTime)) / interval) + 1;
            let timestampArr = [],
                res = [];
            for (let i = 0; i < timeStepCount; i++) {
                res.push(data.filter((item, index) => {
                    return (index - i) % timeStepCount === 0
                }));
                timestampArr.push(res[i][0].timestamp);
            }
            return {
                data: res,
                timestampArr: timestampArr
            };
        }

        /**
         * progressCallback 用于响应进度条移动事件的回调函数
         * @param index - 进度条的移动位置
         */
        function progressCallback(index) {
            // dataToUse = dataModel.formulaPreprocess(historyData[index]);
            dataModel.setNodeStatusByValue(dataToUse);
            let isDisplay = document.getElementById("data-display-div") ? document.getElementById("data-display-div").style.display: null;
            if (isDisplay !== null && isDisplay !== "none") {
                let nodeArr = dataToUse.filter(item => item.nodeTag === nodeSelected);
                let type = dataModel.getDataByNodeTag(nodeArr[0].nodeTag)[0].a('node.type');
                updateNodeDetails(nodeArr[0].value, dataToUse[0].timestamp, type);
            }
        }

    </script>
</head>
<body onload="init();">
    <div id="container"></div>
</body>
</html>
